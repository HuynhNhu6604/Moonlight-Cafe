<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moonlight Cafe - Cà phê & Bánh ngọt</title>
    <meta name="description"
        content="Moonlight Cafe - Nơi thưởng thức cà phê và bánh ngọt thượng hạng trong không gian ấm cúng dưới ánh trăng.">

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/mobile.css">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay">
        <div class="loader"></div>
    </div>

    <!-- Navigation Overlay -->
    <div class="nav-overlay" id="navOverlay"></div>

    <!-- Header -->
    <header class="header" id="header">
        <div class="container">
            <nav class="nav">
                <a href="index.html" class="nav-brand">
                    <div class="nav-logo-wrapper"><img src="images/logo.png?v=4" alt="Moonlight Cafe" class="nav-logo"></div>
                    <span class="nav-brand-text">Moonlight Cafe</span>
                </a>

                <ul class="nav-menu" id="navMenu">
                    <li><a href="index.html" class="nav-link active">Trang chủ</a></li>
                    <li><a href="menu.html" class="nav-link">Menu</a></li>
                    <li><a href="promotions.html" class="nav-link">Khuyến mãi</a></li>
                    <li><a href="news.html" class="nav-link">Tin tức</a></li>
                    <li><a href="about.html" class="nav-link">Về chúng tôi</a></li>
                    <li><a href="contact.html" class="nav-link">Liên hệ</a></li>
                    <li><a href="reservation.html" class="nav-link">Đặt bàn</a></li>
                    <li class="admin-nav-item hidden"><a href="admin.html" class="nav-link admin-link">
                            <i class="fas fa-cog"></i> Quản trị
                        </a></li>
                </ul>

                <div class="nav-actions">
                    <button class="nav-icon" id="darkModeToggle" title="Chế độ tối/sáng">
                        <i class="fas fa-moon"></i>
                    </button>
                    <a href="contact.html" class="nav-icon hidden" id="msgIcon" title="Tin nhắn từ tiệm">
                        <i class="fas fa-envelope"></i>
                        <span class="badge" id="msgCount" style="display:none">0</span>
                    </a>
                    <a href="cart.html" class="nav-icon" id="cartIcon">
                        <i class="fas fa-shopping-bag"></i>
                        <span class="badge" id="cartCount">0</span>
                    </a>
                    <a href="#" class="nav-icon" id="userIcon">
                        <i class="fas fa-user"></i>
                    </a>
                    <div class="nav-toggle" id="navToggle">
                        <div class="nav-logo-wrapper"><img src="images/logo.png?v=4" alt="Moonlight Cafe" class="nav-logo"></div>
                        <div class="nav-logo-wrapper"><img src="images/logo.png?v=4" alt="Moonlight Cafe" class="nav-logo"></div>
                        <div class="nav-logo-wrapper"><img src="images/logo.png?v=4" alt="Moonlight Cafe" class="nav-logo"></div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="hero">
        <div class="container">
            <div class="hero-content">
                <span class="hero-subtitle">✨ Chào mừng đến với Moonlight</span>
                <h1 class="hero-title">Thưởng thức <span>Cà phê</span> dưới ánh trăng</h1>
                <p class="hero-description">
                    Nơi hội tụ của hương vị cà phê thượng hạng và những chiếc bánh ngọt tinh tế.
                    Tận hưởng không gian ấm cúng, lãng mạn dưới ánh trăng.
                </p>
                <div class="hero-buttons">
                    <a href="menu.html" class="btn btn-primary">
                        <i class="fas fa-coffee"></i> Xem Menu
                    </a>
                    <a href="#featured" class="btn btn-outline">
                        <i class="fas fa-star"></i> Món nổi bật
                    </a>
                </div>
            </div>
        </div>

        <!-- Hero Background Elements -->
        <div class="hero-bg-elements">
            <div class="hero-moon"></div>
            <div class="hero-stars"></div>
        </div>
    </section>

    <!-- Featured Menu Section -->
    <section class="section" id="featured">
        <div class="container">
            <div class="section-header">
                <span class="section-subtitle">Sản phẩm nổi bật</span>
                <h2 class="section-title">Best Seller</h2>
                <div class="section-divider"></div>
            </div>

            <div class="product-grid" id="featuredProducts">
                <!-- Products will be loaded from Firebase -->
                <div class="product-card skeleton">
                    <div class="product-img-wrapper">
                        <div class="skeleton-img"></div>
                    </div>
                    <div class="product-info">
                        <div class="skeleton-text"></div>
                        <div class="skeleton-text short"></div>
                    </div>
                </div>
                <div class="product-card skeleton">
                    <div class="product-img-wrapper">
                        <div class="skeleton-img"></div>
                    </div>
                    <div class="product-info">
                        <div class="skeleton-text"></div>
                        <div class="skeleton-text short"></div>
                    </div>
                </div>
                <div class="product-card skeleton">
                    <div class="product-img-wrapper">
                        <div class="skeleton-img"></div>
                    </div>
                    <div class="product-info">
                        <div class="skeleton-text"></div>
                        <div class="skeleton-text short"></div>
                    </div>
                </div>
                <div class="product-card skeleton">
                    <div class="product-img-wrapper">
                        <div class="skeleton-img"></div>
                    </div>
                    <div class="product-info">
                        <div class="skeleton-text"></div>
                        <div class="skeleton-text short"></div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-5">
                <a href="menu.html" class="btn btn-outline">
                    Xem tất cả <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </section>

    <!-- About Section -->
    <section class="section about-section">
        <div class="container">
            <div class="about-grid">
                <div class="about-image">
                    <img src="https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=600"
                        alt="Moonlight Cafe Interior">
                    <div class="about-badge">
                        <span class="badge-number">5+</span>
                        <span class="badge-text">Năm kinh nghiệm</span>
                    </div>
                </div>
                <div class="about-content">
                    <span class="section-subtitle">Câu chuyện của chúng tôi</span>
                    <h2 class="section-title">Nơi những tách cà phê kể chuyện</h2>
                    <p>
                        Moonlight Cafe ra đời từ tình yêu với cà phê và mong muốn tạo ra một không gian
                        nơi mọi người có thể thư giãn, kết nối và tận hưởng những khoảnh khắc đẹp.
                    </p>
                    <p>
                        Chúng tôi tự hào với nguồn nguyên liệu cao cấp, được tuyển chọn kỹ lưỡng từ
                        các vùng trồng cà phê nổi tiếng và những công thức bánh độc quyền.
                    </p>
                    <div class="about-features">
                        <div class="about-feature">
                            <i class="fas fa-leaf"></i>
                            <span>100% Organic</span>
                        </div>
                        <div class="about-feature">
                            <i class="fas fa-award"></i>
                            <span>Chất lượng cao</span>
                        </div>
                        <div class="about-feature">
                            <i class="fas fa-heart"></i>
                            <span>Làm với tình yêu</span>
                        </div>
                    </div>
                    <a href="about.html" class="btn btn-primary mt-3">
                        Tìm hiểu thêm <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Testimonials Section -->
    <section class="section testimonials-section">
        <div class="container">
            <div class="section-header">
                <span class="section-subtitle">Đánh giá</span>
                <h2 class="section-title">Khách hàng nói gì về chúng tôi</h2>
                <div class="section-divider"></div>
            </div>

            <div class="testimonials-slider" id="testimonials">
                <!-- Loaded dynamically from Firebase -->
                <div style="text-align:center;padding:40px;color:var(--text-secondary)">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p style="margin-top:12px">Đang tải đánh giá...</p>
                </div>
            </div>

            <div style="text-align:center;margin-top:24px">
                <a href="contact.html" class="btn btn-outline" style="display:inline-flex;align-items:center;gap:8px">
                    <i class="fas fa-star"></i> Viết đánh giá của bạn
                </a>
            </div>
        </div>
    </section>

    <!-- Gallery Section -->
    <section class="section gallery-section">
        <div class="container">
            <div class="section-header">
                <span class="section-subtitle">Hình ảnh</span>
                <h2 class="section-title">Không gian Moonlight</h2>
                <div class="section-divider"></div>
            </div>

            <div class="gallery-grid">

                <!-- Ảnh 1: dọc (portrait) — đặt images/gallery/anh-1.jpg -->
                <div class="gallery-item g-tall" id="g1">
                    <img src="images/gallery/anh-1.jpg" alt="Không gian quán">
                    <div class="gallery-placeholder">
                        <i class="fas fa-camera"></i>
                        <b>Không gian quán</b>
                        <span>images/gallery/anh-1.jpg</span>
                    </div>
                    <div class="gallery-overlay">
                        <span class="gallery-label">✨ Không gian quán</span>
                        <i class="fas fa-expand-alt"></i>
                    </div>
                </div>

                <!-- Ảnh 2: vuông trên giữa — đặt images/gallery/anh-2.jpg -->
                <div class="gallery-item" id="g2">
                    <img src="images/gallery/anh-2.jpg" alt="Cà phê đặc trưng">
                    <div class="gallery-placeholder">
                        <i class="fas fa-camera"></i>
                        <b>Cà phê đặc trưng</b>
                        <span>images/gallery/anh-2.jpg</span>
                    </div>
                    <div class="gallery-overlay">
                        <span class="gallery-label">☕ Cà phê đặc trưng</span>
                        <i class="fas fa-expand-alt"></i>
                    </div>
                </div>

                <!-- Ảnh 3: vuông trên phải — đặt images/gallery/anh-3.jpg -->
                <div class="gallery-item" id="g3">
                    <img src="images/gallery/anh-3.jpg" alt="Quầy pha chế">
                    <div class="gallery-placeholder">
                        <i class="fas fa-camera"></i>
                        <b>Quầy pha chế</b>
                        <span>images/gallery/anh-3.jpg</span>
                    </div>
                    <div class="gallery-overlay">
                        <span class="gallery-label">🌟 Quầy pha chế</span>
                        <i class="fas fa-expand-alt"></i>
                    </div>
                </div>

                <!-- Ảnh 4: vuông dưới giữa — đặt images/gallery/anh-4.jpg -->
                <div class="gallery-item" id="g4">
                    <img src="images/gallery/anh-4.jpg" alt="Bánh ngọt">
                    <div class="gallery-placeholder">
                        <i class="fas fa-camera"></i>
                        <b>Bánh ngọt</b>
                        <span>images/gallery/anh-4.jpg</span>
                    </div>
                    <div class="gallery-overlay">
                        <span class="gallery-label">🍰 Bánh ngọt</span>
                        <i class="fas fa-expand-alt"></i>
                    </div>
                </div>

                <!-- Ảnh 5: vuông dưới phải — đặt images/gallery/anh-5.jpg -->
                <div class="gallery-item" id="g5">
                    <img src="images/gallery/anh-5.jpg" alt="Thức uống">
                    <div class="gallery-placeholder">
                        <i class="fas fa-camera"></i>
                        <b>Thức uống</b>
                        <span>images/gallery/anh-5.jpg</span>
                    </div>
                    <div class="gallery-overlay">
                        <span class="gallery-label">🥤 Thức uống</span>
                        <i class="fas fa-expand-alt"></i>
                    </div>
                </div>

                <!-- Ảnh 6: ngang toàn bộ (panorama) — đặt images/gallery/anh-6.jpg -->
                <div class="gallery-item g-wide" id="g6">
                    <img src="images/gallery/anh-6.jpg" alt="Ngoại thất quán">
                    <div class="gallery-placeholder">
                        <i class="fas fa-camera"></i>
                        <b>Ngoại thất / Toàn cảnh quán</b>
                        <span>images/gallery/anh-6.jpg</span>
                    </div>
                    <div class="gallery-overlay">
                        <span class="gallery-label">🏛️ Moonlight Cafe — Cần Thơ</span>
                        <i class="fas fa-expand-alt"></i>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- CTA Section -->
    <section class="section cta-section">
        <div class="container">
            <div class="cta-content">
                <h2>Sẵn sàng thưởng thức?</h2>
                <p>Đặt hàng online ngay hôm nay và nhận ưu đãi 10% cho đơn hàng đầu tiên!</p>
                <div class="cta-buttons">
                    <a href="menu.html" class="btn btn-primary btn-lg">
                        <i class="fas fa-shopping-bag"></i> Đặt hàng ngay
                    </a>
                    <a href="tel:0110766204" class="btn btn-outline btn-lg">
                        <i class="fas fa-phone"></i> 0110 766 204
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <div class="footer-brand">
                        <div class="nav-logo-wrapper"><img src="images/logo.png?v=4" alt="Moonlight Cafe" class="nav-logo"></div>
                        <span class="nav-brand-text">Moonlight Cafe</span>
                    </div>
                    <p id="footer-slogan">
                        Nơi thưởng thức cà phê và bánh ngọt thượng hạng
                        trong không gian ấm cúng dưới ánh trăng.
                    </p>
                    <div class="footer-social">
                        <a href="#" id="footer-fb"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" id="footer-ig"><i class="fab fa-instagram"></i></a>
                        <a href="#" id="footer-tt"><i class="fab fa-tiktok"></i></a>
                        <a href="#" id="footer-yt"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>

                <div class="footer-col">
                    <h4 class="footer-title">Liên kết nhanh</h4>
                    <ul class="footer-links">
                        <li><a href="index.html">Trang chủ</a></li>
                        <li><a href="menu.html">Menu</a></li>
                        <li><a href="news.html">Tin tức</a></li>
                        <li><a href="about.html">Về chúng tôi</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h4 class="footer-title">Hỗ trợ</h4>
                    <ul class="footer-links">
                        <li><a href="orders.html">Theo dõi đơn hàng</a></li>
                        <li><a href="#">Chính sách đổi trả</a></li>
                        <li><a href="#">FAQ</a></li>
                        <li><a href="#">Liên hệ</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h4 class="footer-title">Liên hệ</h4>
                    <ul class="footer-contact">
                        <li>
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="footer-address">66 Nguyễn Đệ, Cái Khế, Cần Thơ</span>
                        </li>
                        <li>
                            <i class="fas fa-phone"></i>
                            <span id="footer-phone">0110 766 204</span>
                        </li>
                        <li>
                            <i class="fas fa-envelope"></i>
                            <span id="footer-email">moonlightcafe@gmail.com</span>
                        </li>
                        <li>
                            <i class="fas fa-clock"></i>
                            <span id="footer-hours">7:00 - 22:00 hàng ngày</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p id="footer-copyright">&copy; 2026 Moonlight Cafe. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- User Dropdown Menu -->
    <div class="user-dropdown" id="userDropdown">
        <div class="user-dropdown-header" id="userInfo">
            <i class="fas fa-user-circle"></i>
            <span>Khách</span>
        </div>
        <div class="user-dropdown-menu">
            <a href="login.html" class="dropdown-item" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Đăng nhập
            </a>
            <a href="register.html" class="dropdown-item" id="registerBtn">
                <i class="fas fa-user-plus"></i> Đăng ký
            </a>
            <a href="orders.html" class="dropdown-item logged-in-only hidden">
                <i class="fas fa-box"></i> Đơn hàng của tôi
            </a>
            <a href="#" class="dropdown-item logged-in-only hidden" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </a>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { auth, db, onAuthStateChanged, ref, get, onValue } from './js/firebase-config.js';
        import { saveUserSession, getCurrentUser, isAdmin, getUserDropdownHTML } from './js/auth-helper.js';
        import { updateMsgBadge, loadStoreInfo } from './js/nav-helper.js';
        loadStoreInfo();

        // DOM Elements
        const header = document.getElementById('header');
        const navToggle = document.getElementById('navToggle');
        const navMenu = document.getElementById('navMenu');
        const navOverlay = document.getElementById('navOverlay');
        const userIcon = document.getElementById('userIcon');
        const userDropdown = document.getElementById('userDropdown');
        const cartCount = document.getElementById('cartCount');
        const featuredProducts = document.getElementById('featuredProducts');
        const darkModeToggle = document.getElementById('darkModeToggle');

        // Dark Mode Toggle
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');

            const isDarkMode = document.body.classList.contains('dark-mode');
            const icon = darkModeToggle.querySelector('i');

            if (isDarkMode) {
                icon.className = 'fas fa-sun';
                localStorage.setItem('darkMode', 'enabled');
            } else {
                icon.className = 'fas fa-moon';
                localStorage.setItem('darkMode', 'disabled');
            }
        });

        // Check saved dark mode preference
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            darkModeToggle.querySelector('i').className = 'fas fa-sun';
        }

        // Loading
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.querySelector('.loading-overlay').classList.add('hidden');
            }, 800);
        });

        // Header scroll effect
        window.addEventListener('scroll', () => {
            if (window.scrollY > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });

        // Mobile menu toggle
        navToggle.addEventListener('click', () => {
            navMenu.classList.toggle('active');
            navOverlay.classList.toggle('active');
        });

        navOverlay.addEventListener('click', () => {
            navMenu.classList.remove('active');
            navOverlay.classList.remove('active');
        });

        // User dropdown toggle
        userIcon.addEventListener('click', (e) => {
            e.preventDefault();
            userDropdown.classList.toggle('active');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!userIcon.contains(e.target) && !userDropdown.contains(e.target)) {
                userDropdown.classList.remove('active');
            }
        });

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            const userInfo = document.getElementById('userInfo');
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const loggedInItems = document.querySelectorAll('.logged-in-only');
            const dropdownMenu = document.querySelector('.user-dropdown-menu');

            if (user) {
                // Lưu thông tin user vào localStorage
                const userData = await saveUserSession(auth, db);

                // Cập nhật dropdown menu với phân quyền
                dropdownMenu.innerHTML = getUserDropdownHTML(userData);

                // Cập nhật tên hiển thị
                const displayName = userData.firstName || userData.lastName
                    ? `${userData.lastName || ''} ${userData.firstName || ''}`.trim()
                    : user.email.split('@')[0];

                userInfo.innerHTML = `
                    <i class="fas fa-user-circle"></i>
                    <span>${displayName}</span>
                `;

                loginBtn.classList.add('hidden');
                registerBtn.classList.add('hidden');
                loggedInItems.forEach(item => item.classList.remove('hidden'));

                // Hiển/ẩn link Quản trị dựa trên role
                const adminNavItems = document.querySelectorAll('.admin-nav-item');
                const isUserAdmin = isAdmin(userData);
                adminNavItems.forEach(item => {
                    if (isUserAdmin) {
                        item.classList.remove('hidden');
                        if (!item.classList.contains('nav-link')) {
                            item.style.display = 'flex';
                        }
                    } else {
                        item.classList.add('hidden');
                        item.style.display = '';
                    }
                });

                // Gắn sự kiện logout
                document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
                // Cập nhật badge tin nhắn
                updateMsgBadge(user.uid);
            } else {
                localStorage.removeItem('moonlight_user');

                userInfo.innerHTML = `
                    <i class="fas fa-user-circle"></i>
                    <span>Khách</span>
                `;

                dropdownMenu.innerHTML = getUserDropdownHTML(null);
                loginBtn.classList.remove('hidden');
                registerBtn.classList.remove('hidden');
                loggedInItems.forEach(item => item.classList.add('hidden'));

                // Ẩn link Quản trị
                document.querySelectorAll('.admin-nav-item').forEach(item => {
                    item.classList.add('hidden');
                });
                // Ẩn badge tin nhắn
                updateMsgBadge(null);
            }
        });

        // Logout handler
        async function handleLogout(e) {
            e.preventDefault();
            try {
                await auth.signOut();
                localStorage.removeItem('moonlight_user');
                Swal.fire({
                    icon: 'success',
                    title: 'Đăng xuất thành công!',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = 'index.html';
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Logout handler (centralized above)

        // Update cart count
        function updateCartCount() {
            const user = auth.currentUser;
            if (!user) { cartCount.textContent = 0; return; }
            const cart = JSON.parse(localStorage.getItem(`moonlight_cart_${user.uid}`)) || [];
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
        }

        updateCartCount();

        // Listen for cart changes
        window.addEventListener('storage', (e) => {
            const user = auth.currentUser;
            if (user && e.key === `moonlight_cart_${user.uid}`) {
                updateCartCount();
            }
        });

        // Load featured products
        async function loadFeaturedProducts() {
            try {
                const productsRef = ref(db, 'products');
                const snapshot = await get(productsRef);

                if (snapshot.exists()) {
                    const products = [];
                    snapshot.forEach((child) => {
                        const product = child.val();
                        product.id = child.key;
                        if (product.isAvailable !== false) {
                            products.push(product);
                        }
                    });

                    // Get first 4 products as featured
                    const featured = products.slice(0, 4);
                    renderFeaturedProducts(featured);
                } else {
                    featuredProducts.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--text-muted); padding: 40px;">Chưa có sản phẩm nổi bật</div>';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                featuredProducts.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--text-muted); padding: 40px;">Có lỗi xảy ra khi tải sản phẩm</div>';
            }
        }

        function renderFeaturedProducts(products) {
            if (!products || products.length === 0) {
                featuredProducts.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--text-muted); padding: 40px;">Chưa có sản phẩm nổi bật</div>';
                return;
            }

            const favorites = JSON.parse(localStorage.getItem('moonlight_wishlist')) || [];

            featuredProducts.innerHTML = products.map(product => {
                const isFavorite = favorites.some(item => String(item.id) === String(product.id));
                const heartClass = isFavorite ? 'fas fa-heart active' : 'far fa-heart';

                return `
                <div class="product-card">
                    <div class="product-img-wrapper">
                        <img src="${product.imageUrl || 'https://via.placeholder.com/300x220'}" 
                             alt="${product.name}" class="product-img" onclick="viewProduct('${product.id}')" style="cursor: pointer;">
                        ${product.badge ? `<span class="product-badge">${product.badge}</span>` : ''}
                        <div class="product-actions">
                            <button class="product-action-btn" onclick="addToCart('${product.id}', '${product.name.replace(/'/g, "\\'")}', ${product.price}, '${product.imageUrl || ''}')" title="Thêm vào giỏ hàng">
                                <i class="fas fa-shopping-bag"></i>
                            </button>
                            <button class="product-action-btn" onclick="toggleFavorite('${product.id}', '${product.name.replace(/'/g, "\\'")}', ${product.price}, '${product.imageUrl || ''}', '${product.category || 'coffee'}')" title="Yêu thích">
                                <i class="${heartClass}" id="heart-icon-index-${product.id}"></i>
                            </button>
                            <button class="product-action-btn" onclick="viewProduct('${product.id}')" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="product-info">
                        <span class="product-category">${product.category || 'Cà phê'}</span>
                        <h4 class="product-name" onclick="viewProduct('${product.id}')" style="cursor: pointer;">${product.name}</h4>
                        <div class="product-price">
                            ${formatPrice(product.price)}
                            ${product.oldPrice ? `<span class="product-price-old">${formatPrice(product.oldPrice)}</span>` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        // Add to cart function
        window.addToCart = function (id, name, price, imageUrl) {
            const user = auth.currentUser;
            if (!user) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Chưa đăng nhập',
                    text: 'Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng!',
                    showCancelButton: true,
                    confirmButtonText: 'Đăng nhập',
                    cancelButtonText: 'Hủy',
                    confirmButtonColor: '#d4a574'
                }).then((result) => {
                    if (result.isConfirmed) window.location.href = 'login.html';
                });
                return;
            }
            const cartKey = `moonlight_cart_${user.uid}`;
            const cart = JSON.parse(localStorage.getItem(cartKey)) || [];
            const existingItem = cart.find(item => item.id === id);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ id, name, price, imageUrl, quantity: 1 });
            }

            localStorage.setItem(cartKey, JSON.stringify(cart));
            updateCartCount();

            Swal.fire({
                icon: 'success',
                title: 'Đã thêm vào giỏ hàng!',
                timer: 1500,
                showConfirmButton: false,
                position: 'top-end',
                toast: true
            });
        };

        window.viewProduct = function (id) {
            window.location.href = `product-detail.html?id=${id}`;
        };

        window.toggleFavorite = function (id, name, price, imageUrl, category) {
            let wishlist = JSON.parse(localStorage.getItem('moonlight_wishlist')) || [];
            const index = wishlist.findIndex(item => String(item.id) === String(id));
            const icon = document.getElementById(`heart-icon-index-${id}`);

            if (index > -1) {
                wishlist.splice(index, 1);
                if (icon) {
                    icon.className = 'far fa-heart';
                }
                Swal.fire({
                    icon: 'success',
                    title: 'Đã bỏ yêu thích',
                    text: 'Sản phẩm đã được xóa khỏi danh sách yêu thích.',
                    toast: true,
                    position: 'bottom-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            } else {
                wishlist.push({ id, name, price: parseInt(price), image: imageUrl, category });
                if (icon) {
                    icon.className = 'fas fa-heart active';
                }
                Swal.fire({
                    icon: 'success',
                    title: 'Đã thêm yêu thích',
                    text: 'Sản phẩm đã ghim vào mục Yêu thích.',
                    toast: true,
                    position: 'bottom-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }

            localStorage.setItem('moonlight_wishlist', JSON.stringify(wishlist));
        };

        // Gallery: hiện khung placeholder mặc định, ẩn khi ảnh load xong
        document.querySelectorAll('.gallery-item img').forEach(img => {
            const item = img.closest('.gallery-item');
            item.classList.add('no-img'); // mặc định hiện placeholder
            img.addEventListener('load',  () => { if (img.naturalWidth > 0) item.classList.remove('no-img'); });
            img.addEventListener('error', () => item.classList.add('no-img'));
            // Nếu ảnh đã cached và load thành công
            if (img.complete && img.naturalWidth > 0) item.classList.remove('no-img');
        });

        // Gallery lightbox (chỉ mở khi có ảnh thật)
        document.querySelectorAll('.gallery-item').forEach(item => {
            item.addEventListener('click', () => {
                if (item.classList.contains('no-img')) return;
                const img = item.querySelector('img');
                Swal.fire({
                    imageUrl: img.src,
                    imageAlt: img.alt,
                    showConfirmButton: false,
                    showCloseButton: true,
                    width: 'auto',
                    background: 'transparent'
                });
            });
        });

        // Load approved reviews/testimonials from Firebase
        async function loadTestimonials() {
            const container = document.getElementById('testimonials');
            try {
                const snap = await get(ref(db, 'reviews'));
                const approved = [];
                if (snap.exists()) {
                    snap.forEach(c => {
                        const r = c.val();
                        if (r.status === 'approved') approved.push(r);
                    });
                }
                approved.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

                if (approved.length === 0) {
                    container.innerHTML = `
                        <div style="text-align:center;padding:40px;color:var(--text-secondary)">
                            <i class="fas fa-star" style="font-size:2rem;opacity:.4"></i>
                            <p style="margin-top:12px">Chưa có đánh giá nào. Hãy là người đầu tiên!</p>
                        </div>`;
                    return;
                }

                function starsHTML(n) {
                    let s = '';
                    for (let i = 1; i <= 5; i++)
                        s += `<i class="${i <= n ? 'fas' : 'far'} fa-star"></i>`;
                    return s;
                }

                // Show up to 6 most recent approved reviews
                container.innerHTML = approved.slice(0, 6).map(r => `
                    <div class="testimonial-card">
                        <div class="testimonial-rating">${starsHTML(r.rating || 5)}</div>
                        <p class="testimonial-text">"${r.content}"</p>
                        <div class="testimonial-author">
                            <div class="testimonial-avatar" style="width:48px;height:48px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:1.1rem;flex-shrink:0">
                                ${(r.userName || '?')[0].toUpperCase()}
                            </div>
                            <div class="testimonial-author-info">
                                <h5>${r.userName || 'Khách hàng'}</h5>
                                <span>${new Date(r.createdAt || Date.now()).toLocaleDateString('vi-VN')}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = `<div style="text-align:center;padding:30px;color:var(--text-secondary)">Không thể tải đánh giá.</div>`;
            }
        }

        // Initialize
        loadFeaturedProducts();
        loadTestimonials();
    </script>

    <style>
        /* Additional Homepage Styles */
        .hero {
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--primary) 50%, var(--primary-light) 100%);
            position: relative;
        }

        .hero-bg-elements {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .hero-moon {
            position: absolute;
            top: 10%;
            right: 10%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, #ffd700 0%, #ffb347 50%, transparent 70%);
            border-radius: 50%;
            box-shadow: 0 0 100px 50px rgba(255, 215, 0, 0.2);
            animation: moonGlow 4s ease-in-out infinite;
        }

        @keyframes moonGlow {

            0%,
            100% {
                box-shadow: 0 0 100px 50px rgba(255, 215, 0, 0.2);
            }

            50% {
                box-shadow: 0 0 120px 60px rgba(255, 215, 0, 0.3);
            }
        }

        .hero-stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(2px 2px at 20px 30px, white, transparent),
                radial-gradient(2px 2px at 40px 70px, white, transparent),
                radial-gradient(2px 2px at 50px 160px, white, transparent),
                radial-gradient(2px 2px at 90px 40px, white, transparent),
                radial-gradient(2px 2px at 130px 80px, white, transparent),
                radial-gradient(2px 2px at 160px 120px, white, transparent);
            background-repeat: repeat;
            background-size: 200px 200px;
            animation: twinkle 5s ease-in-out infinite;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        /* About Section */
        .about-section {
            background: var(--primary);
        }

        .about-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            align-items: center;
        }

        .about-image {
            position: relative;
        }

        .about-image img {
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        .about-badge {
            position: absolute;
            bottom: -20px;
            right: -20px;
            background: var(--accent);
            color: var(--text-dark);
            padding: 20px;
            border-radius: var(--radius-md);
            text-align: center;
            box-shadow: var(--shadow-glow);
        }

        .badge-number {
            display: block;
            font-size: 2rem;
            font-weight: 700;
        }

        .badge-text {
            font-size: 0.9rem;
        }

        .about-features {
            display: flex;
            gap: 30px;
            margin-top: 2rem;
        }

        .about-feature {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent);
        }

        .about-feature i {
            font-size: 1.25rem;
        }

        /* Testimonials */
        .testimonials-section {
            background: linear-gradient(135deg, var(--bg-dark), var(--primary-dark));
        }

        .testimonials-slider {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .testimonial-card {
            background: var(--bg-card);
            padding: 30px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
        }

        .testimonial-rating {
            color: #ffc107;
            margin-bottom: 1rem;
        }

        .testimonial-text {
            font-style: italic;
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
        }

        .testimonial-author {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .testimonial-author img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .testimonial-author-info h5 {
            margin: 0;
            font-size: 1rem;
        }

        .testimonial-author-info span {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Gallery — bento layout chuyên nghiệp
           [ 1-dọc  ][ 2-vuông ][ 3-vuông ]
           [ 1-dọc  ][ 4-vuông ][ 5-vuông ]
           [ 6-ngang toàn bộ 3 cột       ]
        */
        .gallery-grid {
            display: grid;
            grid-template-columns: 1.1fr 1fr 1fr;
            grid-template-rows: 320px 280px 360px;
            gap: 12px;
        }

        /* Ảnh 1: dọc (span 2 hàng) */
        .gallery-item.g-tall  { grid-row: span 2; }

        /* Ảnh 6: ngang toàn bộ */
        .gallery-item.g-wide  { grid-column: span 3; }

        .gallery-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            background: rgba(255,255,255,0.03);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            display: block;
            transition: transform 0.5s ease;
        }

        .gallery-item:hover img { transform: scale(1.05); }

        /* --- Placeholder khi chưa có ảnh --- */
        .gallery-item .gallery-placeholder {
            display: none;
            position: absolute;
            inset: 0;
            border: 2px dashed rgba(245,158,11,0.45);
            border-radius: 10px;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: rgba(245,158,11,0.65);
            font-family: 'Poppins', sans-serif;
            text-align: center;
            padding: 10px;
            pointer-events: none;
        }
        .gallery-item.no-img .gallery-placeholder { display: flex; }
        .gallery-item.no-img img { visibility: hidden; }
        .gallery-placeholder i   { font-size: 1.8rem; }
        .gallery-placeholder b   { font-size: 0.82rem; font-weight: 600; display: block; }
        .gallery-placeholder span { font-size: 0.7rem; opacity: 0.7; }

        /* --- Overlay hover --- */
        .gallery-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 50%);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-end;
            padding: 14px 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .gallery-item:not(.no-img):hover .gallery-overlay { opacity: 1; }
        .gallery-label {
            font-family: 'Poppins', sans-serif;
            font-size: 0.82rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 5px;
            display: block;
        }
        .gallery-overlay > i { font-size: 1rem; color: var(--accent); }

        /* --- Responsive --- */
        @media (max-width: 900px) {
            .gallery-grid {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 200px 200px 180px 160px;
            }
            .gallery-item.g-tall { grid-row: span 2; }
            .gallery-item.g-wide { grid-column: span 2; }
        }
        @media (max-width: 500px) {
            .gallery-grid {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 150px 150px 130px 120px;
                gap: 8px;
            }
        }

        /* CTA Section */
        .cta-section {
            background: linear-gradient(135deg, var(--accent-dark), var(--accent));
            text-align: center;
        }

        .cta-content h2 {
            color: var(--text-dark);
        }

        .cta-content p {
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        .cta-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .cta-section .btn-primary {
            background: var(--primary);
            color: var(--text-primary);
        }

        .cta-section .btn-outline {
            border-color: var(--primary);
            color: var(--primary);
        }

        .cta-section .btn-outline:hover {
            background: var(--primary);
            color: var(--text-primary);
        }

        /* User Dropdown */
        .user-dropdown {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition-normal);
            z-index: 1001;
        }

        .user-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-bottom: 1px solid var(--secondary);
        }

        .user-dropdown-header i {
            font-size: 1.5rem;
            color: var(--accent);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            color: var(--text-secondary);
            transition: var(--transition-fast);
        }

        .dropdown-item:hover {
            background: var(--bg-card-hover);
            color: var(--accent);
        }

        /* Admin Nav Item */
        .admin-nav-item {
            display: none;
            margin-left: 10px;
        }

        .admin-nav-item .nav-link {
            background: var(--accent);
            color: var(--text-dark);
            padding: 8px 16px;
            border-radius: var(--radius-full);
        }

        .admin-nav-item .nav-link:hover {
            background: var(--accent-dark);
            color: var(--text-dark);
        }

        /* Skeleton Loading */
        .skeleton .skeleton-img {
            width: 100%;
            height: 220px;
            background: linear-gradient(90deg, var(--secondary) 25%, var(--secondary-light) 50%, var(--secondary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .skeleton .skeleton-text {
            height: 15px;
            background: var(--secondary);
            border-radius: 4px;
            margin-bottom: 10px;
            animation: shimmer 1.5s infinite;
        }

        .skeleton .skeleton-text.short {
            width: 60%;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        /* Dark Mode Toggle */
        .dark-mode-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .dark-mode-toggle:hover {
            background: var(--primary-light);
        }

        .dark-mode-toggle i {
            font-size: 1.2rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .dark-mode-toggle:hover i {
            color: var(--accent);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --bg-card-hover: #2a2a2a;
            --primary-light: #2a2a2a;
            --secondary: #333;
            --secondary-light: #404040;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #888;
            --text-dark: #ffffff;
            --bg-overlay: rgba(0, 0, 0, 0.7);
        }

        body.dark-mode .header.scrolled {
            background: rgba(18, 18, 18, 0.95);
        }

        body.dark-mode .product-card {
            background: var(--bg-card);
        }

        body.dark-mode .menu-item {
            background: var(--bg-card);
        }

        body.dark-mode .cart-card,
        body.dark-mode .cart-summary,
        body.dark-mode .checkout-card,
        body.dark-mode .order-summary,
        body.dark-mode .order-card {
            background: var(--bg-card);
        }

        body.dark-mode .form-control {
            background: var(--primary-light);
            border-color: var(--secondary);
        }

        body.dark-mode .form-control:focus {
            border-color: var(--accent);
        }

        body.dark-mode .quantity-btn {
            background: var(--secondary);
        }

        body.dark-mode .footer {
            background: #0d0d0d;
        }

        body.dark-mode .footer-bottom {
            border-top-color: var(--secondary);
        }

        body.dark-mode .login-required,
        body.dark-mode .empty-cart,
        body.dark-mode .empty-orders {
            background: var(--bg-card);
        }

        body.dark-mode .testimonial-card {
            background: var(--bg-card);
        }

        body.dark-mode .news-card {
            background: var(--bg-card);
        }

        /* Responsive */
        @media (max-width: 992px) {
            .about-grid {
                grid-template-columns: 1fr;
                gap: 40px;
            }

            .about-badge {
                bottom: 20px;
                right: 20px;
            }

            .hero-moon {
                width: 150px;
                height: 150px;
                top: 5%;
                right: 5%;
            }
        }

        @media (max-width: 768px) {
            .about-features {
                flex-wrap: wrap;
            }

            .cta-buttons {
                flex-direction: column;
                align-items: center;
            }

            .hero-moon {
                width: 100px;
                height: 100px;
            }
        }
    </style>

    <!-- TuDongChat AI Chatbot -->
    <script src="https://app.tudongchat.com/js/chatbox.js"></script>
    <script>
        try {
            const tudong_chatbox = new TuDongChat('XUitpr3VDU2e5vJgSRYO9');
            tudong_chatbox.initial();
        } catch(e) {}
    </script>
</body>

</html>