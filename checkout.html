<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán - Moonlight Cafe</title>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/mobile.css">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .page-header {
            background: linear-gradient(135deg, var(--bg-dark), var(--primary));
            padding: 50px 0 50px;
            text-align: center;
        }

        .page-header h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .checkout-section {
            padding: 60px 0;
        }

        .checkout-container {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 40px;
            align-items: start;
        }

        /* Steps */
        .checkout-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            gap: 20px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-muted);
        }

        .step.active {
            color: var(--accent);
        }

        .step.completed {
            color: var(--success);
        }

        .step-number {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .step.active .step-number {
            background: var(--accent);
            color: var(--text-dark);
        }

        .step.completed .step-number {
            background: var(--success);
            color: var(--text-dark);
        }

        .step-line {
            width: 60px;
            height: 2px;
            background: var(--secondary);
        }

        .step-line.completed {
            background: var(--success);
        }

        /* Checkout Form */
        .checkout-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 30px;
            margin-bottom: 25px;
        }

        .checkout-card-title {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkout-card-title i {
            color: var(--accent);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-label .required {
            color: var(--danger);
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            background: var(--primary-light);
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-control:focus {
            border-color: var(--accent);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Payment Methods */
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: var(--primary-light);
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .payment-method:hover {
            border-color: var(--secondary);
        }

        .payment-method.selected {
            border-color: var(--accent);
            background: rgba(212, 165, 116, 0.1);
        }

        .payment-method input {
            accent-color: var(--accent);
        }

        .payment-method-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--secondary);
            border-radius: var(--radius-sm);
            font-size: 1.25rem;
        }

        .payment-method-info h4 {
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .payment-method-info p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 0;
        }

        /* Order Summary */
        .order-summary {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 25px;
            position: sticky;
            top: 100px;
        }

        .summary-title {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--secondary);
        }

        .order-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .order-item {
            display: flex;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid var(--secondary);
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item-img {
            width: 60px;
            height: 50px;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-info h4 {
            font-size: 0.95rem;
            margin-bottom: 3px;
        }

        .order-item-info p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 0;
        }

        .order-item-price {
            font-weight: 600;
            color: var(--accent);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .summary-row.total {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            padding-top: 15px;
            border-top: 1px solid var(--secondary);
            margin-top: 15px;
        }

        .summary-row.total span:last-child {
            color: var(--accent);
        }

        .place-order-btn {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            margin-top: 20px;
        }

        .terms-note {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 15px;
        }

        .terms-note a {
            color: var(--accent);
        }

        @media (max-width: 992px) {
            .checkout-container {
                grid-template-columns: 1fr;
            }

            .order-summary {
                order: -1;
                position: static;
            }

            .checkout-steps {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 2rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .checkout-card {
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay">
        <div class="loader"></div>
    </div>

    <!-- Header -->
    <header class="header scrolled">
        <div class="container">
            <nav class="nav">
                <a href="index.html" class="nav-brand">
                    <div class="nav-logo-wrapper"><img src="images/logo.png?v=4" alt="Moonlight Cafe" class="nav-logo"></div>
                    <span class="nav-brand-text">Moonlight Cafe</span>
                </a>

                <ul class="nav-menu" id="navMenu">
                    <li><a href="index.html" class="nav-link">Trang chủ</a></li>
                    <li><a href="menu.html" class="nav-link">Menu</a></li>
                    <li><a href="promotions.html" class="nav-link">Khuyến mãi</a></li>
                    <li><a href="news.html" class="nav-link">Tin tức</a></li>
                    <li><a href="about.html" class="nav-link">Về chúng tôi</a></li>
                    <li><a href="contact.html" class="nav-link">Liên hệ</a></li>
                    <li><a href="reservation.html" class="nav-link">Đặt bàn</a></li>
                </ul>

                <div class="nav-actions">
                    <a href="contact.html" class="nav-icon hidden" id="msgIcon" title="Tin nhắn từ tiệm">
                        <i class="fas fa-envelope"></i>
                        <span class="badge" id="msgCount" style="display:none">0</span>
                    </a>
                    <a href="cart.html" class="nav-icon">
                        <i class="fas fa-shopping-bag"></i>
                        <span class="badge" id="cartCount">0</span>
                    </a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1>Thanh toán</h1>

            <!-- Steps -->
            <div class="checkout-steps">
                <div class="step completed">
                    <span class="step-number"><i class="fas fa-check"></i></span>
                    <span>Giỏ hàng</span>
                </div>
                <div class="step-line completed"></div>
                <div class="step active">
                    <span class="step-number">2</span>
                    <span>Thanh toán</span>
                </div>
                <div class="step-line"></div>
                <div class="step">
                    <span class="step-number">3</span>
                    <span>Hoàn tất</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Checkout Section -->
    <section class="checkout-section">
        <div class="container">
            <div class="checkout-container">
                <!-- Checkout Form -->
                <div class="checkout-form">
                    <!-- Customer Info -->
                    <div class="checkout-card">
                        <h3 class="checkout-card-title">
                            <i class="fas fa-user"></i> Thông tin khách hàng
                        </h3>

                        <form id="checkoutForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        Họ và tên <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="fullName" placeholder="Nguyễn Văn A"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        Số điện thoại <span class="required">*</span>
                                    </label>
                                    <input type="tel" class="form-control" id="phone" placeholder="0123 456 789"
                                        required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Email <span class="required">*</span>
                                </label>
                                <input type="email" class="form-control" id="email" placeholder="your@email.com"
                                    required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Địa chỉ giao hàng <span class="required">*</span>
                                </label>
                                <input type="text" class="form-control" id="address"
                                    placeholder="Số nhà, đường, phường/xã" required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Quận/Huyện <span class="required">*</span></label>
                                    <select class="form-control" id="district" required>
                                        <option value="">Chọn quận/huyện</option>
                                        <option value="ninhKieu">Quận Ninh Kiều</option>
                                        <option value="binhThuy">Quận Bình Thủy</option>
                                        <option value="caiRang">Quận Cái Răng</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phường/Xã <span class="required">*</span></label>
                                    <select class="form-control" id="ward" required>
                                        <option value="">Chọn quận/huyện trước</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tỉnh/Thành phố</label>
                                <input type="text" class="form-control" id="city" value="Cần Thơ" readonly>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Ghi chú đơn hàng</label>
                                <textarea class="form-control" id="note"
                                    placeholder="Ghi chú về đơn hàng, ví dụ: thời gian giao hàng..."></textarea>
                            </div>
                        </form>
                    </div>

                    <!-- Payment Method -->
                    <div class="checkout-card">
                        <h3 class="checkout-card-title">
                            <i class="fas fa-credit-card"></i> Phương thức thanh toán
                        </h3>

                        <div class="payment-methods">
                            <label class="payment-method selected">
                                <input type="radio" name="payment" value="cod" checked>
                                <div class="payment-method-icon">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="payment-method-info">
                                    <h4>Thanh toán khi nhận hàng (COD)</h4>
                                    <p>Thanh toán bằng tiền mặt khi nhận hàng</p>
                                </div>
                            </label>

                            <div class="payment-method">
                                <input type="radio" name="payment" value="banking">
                                <div class="payment-method-icon">
                                    <i class="fas fa-university"></i>
                                </div>
                                <div class="payment-method-info">
                                    <h4>Chuyển khoản ngân hàng</h4>
                                    <p>Chuyển khoản qua tài khoản ngân hàng</p>
                                </div>
                            </div>

                            <!-- Banking Details -->
                            <div id="bankingDetails" class="payment-details"
                                style="display: none; margin-top: 15px; padding: 20px; background: var(--primary-light); border-radius: var(--radius-sm);">
                                <h4 style="color: var(--accent); margin-bottom: 15px;"><i
                                        class="fas fa-info-circle"></i> Thông tin chuyển khoản</h4>
                                <div style="display: grid; gap: 10px;">
                                    <p><strong>Ngân hàng:</strong> Vietcombank</p>
                                    <p><strong>Số tài khoản:</strong> 1234567890123</p>
                                    <p><strong>Chủ tài khoản:</strong> NGUYEN VAN A</p>
                                    <p><strong>Nội dung:</strong> THANHTOAN [Mã đơn hàng]</p>
                                    <p style="color: var(--accent); font-size: 0.9rem;"><i class="fas fa-star"></i> Vui
                                        lòng chuyển khoản chính xác số tiền để đơn hàng được xử lý nhanh hơn</p>
                                </div>
                            </div>

                            <label class="payment-method">
                                <input type="radio" name="payment" value="momo">
                                <div class="payment-method-icon" style="background: #ae2070; color: white;">
                                    <i class="fas fa-wallet"></i>
                                </div>
                                <div class="payment-method-info">
                                    <h4>Ví MoMo</h4>
                                    <p>Thanh toán qua ví điện tử MoMo</p>
                                </div>
                            </label>

                            <!-- MoMo Details -->
                            <div id="momoDetails" class="payment-details"
                                style="display: none; margin-top: 15px; padding: 20px; background: var(--primary-light); border-radius: var(--radius-sm);">
                                <h4 style="color: #ae2070; margin-bottom: 15px;"><i class="fas fa-info-circle"></i>
                                    Thông tin thanh toán MoMo</h4>
                                <div style="display: grid; gap: 10px;">
                                    <p><strong>Số điện thoại:</strong> 0901234567</p>
                                    <p><strong>Tên tài khoản:</strong> Moonlight Cafe</p>
                                    <p><strong>Nội dung:</strong> THANHTOAN [Mã đơn hàng]</p>
                                    <p style="color: #ae2070; font-size: 0.9rem;"><i class="fas fa-star"></i> Sau khi
                                        chuyển khoản, vui lòng gửi screenshot qua Zalo của shop để xác nhận</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="order-summary">
                    <h3 class="summary-title">Đơn hàng của bạn</h3>

                    <div class="order-items" id="orderItems">
                        <!-- Items will be loaded here -->
                    </div>

                    <div class="summary-row">
                        <span>Tạm tính</span>
                        <span id="subtotal">0đ</span>
                    </div>
                    <div class="summary-row">
                        <span>Phí vận chuyển</span>
                        <span id="shipping">0đ</span>
                    </div>
                    <!-- Promo code -->
                    <div class="summary-row" style="flex-direction:column;align-items:stretch;gap:8px;padding-top:10px">
                        <div id="promoSuggestions" style="margin-bottom:8px;display:none"></div>
                        <div style="display:flex;gap:8px">
                            <input type="text" id="promoCodeInput" placeholder="Nhập mã khuyến mãi" autocomplete="off"
                                style="flex:1;padding:8px 12px;border:1px solid var(--border,#e5e7eb);border-radius:8px;font-size:.92rem;text-transform:uppercase;outline:none;background:var(--bg-secondary,#f9fafb);color:inherit"
                                oninput="this.value=this.value.toUpperCase().replace(/\s/g,'')">
                            <button type="button" onclick="applyPromoCode()"
                                style="padding:8px 14px;background:var(--primary,#8b5cf6);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:.9rem;white-space:nowrap">
                                Áp dụng
                            </button>
                        </div>
                        <div id="promoMsg" style="font-size:.83rem;min-height:1.2em"></div>
                    </div>
                    <div class="summary-row" id="discountRow" style="display:none;color:#10b981">
                        <span>Giảm giá (<span id="appliedPromoCode"></span>)</span>
                        <span id="discountAmt">0đ</span>
                    </div>
                    <div class="summary-row total">
                        <span>Tổng cộng</span>
                        <span id="total">0đ</span>
                    </div>

                    <button class="btn btn-primary place-order-btn" id="placeOrderBtn">
                        <i class="fas fa-check-circle"></i> Đặt hàng
                    </button>

                    <p class="terms-note">
                        Bằng việc đặt hàng, bạn đồng ý với
                        <a href="#">Điều khoản sử dụng</a> của chúng tôi.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <script type="module">
        import { auth, db, ref, push, set, get, onAuthStateChanged } from './js/firebase-config.js';

        let currentUser = null;
        let isGuest = false;

        // Check login required
        function requireLogin() {
            const container = document.querySelector('.checkout-container');
            container.innerHTML = `
                <div style="text-align: center; padding: 80px 20px; background: var(--bg-card); border-radius: var(--radius-md); max-width: 500px; margin: 0 auto;">
                    <i class="fas fa-user-lock" style="font-size: 4rem; color: var(--accent); margin-bottom: 1.5rem;"></i>
                    <h2 style="margin-bottom: 1rem;">Vui lòng đăng nhập</h2>
                    <p style="color: var(--text-muted); margin-bottom: 2rem;">Bạn cần đăng nhập để tiến hành thanh toán</p>
                    <a href="login.html?redirect=checkout.html" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Đăng nhập ngay
                    </a>
                </div>
            `;
        }

        // Loading
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.querySelector('.loading-overlay').classList.add('hidden');
            }, 500);
        });

        // Auth state
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;

            if (!user) {
                requireLogin();
            } else {
                // Pre-fill email
                document.getElementById('email').value = user.email || '';
                // Pre-fill profile from Firebase
                try {
                    const snap = await get(ref(db, `users/${user.uid}`));
                    if (snap.exists()) {
                        const p = snap.val();
                        const nameEl = document.getElementById('fullName');
                        const phoneEl = document.getElementById('phone');
                        const addrEl  = document.getElementById('address');
                        if (nameEl && !nameEl.value)  nameEl.value  = p.fullName || p.displayName || '';
                        if (phoneEl && !phoneEl.value) phoneEl.value = p.phone || '';
                        if (addrEl  && !addrEl.value)  addrEl.value  = p.address || '';
                    }
                } catch (_) {}
                // Render cart (must wait for auth)
                updateCartCount();
                renderOrderItems();
                loadPromoSuggestions();
            }
        });

        // Get cart — chỉ lấy giỏ hàng của user đang đăng nhập
        function getCart() {
            const user = auth.currentUser;
            if (!user) return [];
            return JSON.parse(localStorage.getItem(`moonlight_cart_${user.uid}`)) || [];
        }

        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
        }

        // Update cart count
        function updateCartCount() {
            const cart = getCart();
            const total = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = total;
        }

        // Render order items
        function renderOrderItems() {
            const cart = getCart();
            const orderItems = document.getElementById('orderItems');

            if (cart.length === 0) {
                window.location.href = 'cart.html';
                return;
            }

            orderItems.innerHTML = cart.map(item => `
                <div class="order-item">
                    <img src="${item.imageUrl || 'https://via.placeholder.com/60x50'}" 
                         alt="${item.name}" class="order-item-img">
                    <div class="order-item-info">
                        <h4>${item.name}</h4>
                        <p>x${item.quantity}</p>
                    </div>
                    <span class="order-item-price">${formatPrice(item.price * item.quantity)}</span>
                </div>
            `).join('');

            // Tính phí ship theo phường đang chọn
            const wardSelect = document.getElementById('ward');
            const wardName = wardSelect.options[wardSelect.selectedIndex]?.value || '';
            const subtotalInit = getCart().reduce((s, i) => s + i.price * i.quantity, 0);
            updateTotals(getShippingFee(wardName, subtotalInit));
        }

        // Khoảng cách ước tính từ quán (Cái Khế, Ninh Kiều) theo phường (đơn vị km)
        const wardDistanceKm = {
            // Ninh Kiều
            'Phường Cái Khế': 0,
            'Phường An Hòa': 0.8,
            'Phường An Khánh': 0.9,
            'Phường An Nghiệp': 1.2,
            'Phường An Phú': 1.5,
            'Phường An Bình': 1.8,
            'Phường An Cư': 2.0,
            'Phường An Lạc': 2.2,
            'Phường Tân An': 2.5,
            'Phường Hưng Lợi': 2.8,
            'Phường Xuân Khánh': 3.0,
            'Phường Thới Bình': 3.5,
            'Phường Trà An': 4.0,
            'Phường Trà Nóc': 5.0,
            // Bình Thủy
            'Phường Bình Thủy': 3.5,
            'Phường An Thới': 4.0,
            'Phường Long Tuyền': 4.5,
            'Phường Bùi Hữu Nghĩa': 5.0,
            'Phường Long Hòa': 5.5,
            'Phường Thới An Đông': 6.0,
            // Cái Răng
            'Phường Lê Bình': 3.5,
            'Phường Hưng Phú': 4.0,
            'Phường Ba Láng': 5.0,
            'Phường Phú Thứ': 5.5,
            'Phường Tân Phú': 6.0,
            // Hàng xóm — mặc định 25k
        };

        // Tính phí vận chuyển theo khoảng cách
        // ≤1km: freeship | mỗi km thêm 5.000đ | tối đa 25.000đ
        function getShippingFee(wardName, subtotal) {
            if (!wardName) return 25000; // chưa chọn phường → tạm tính max
            const km = wardDistanceKm[wardName];
            if (km === undefined) return 25000;
            if (km <= 1) return 0;
            const fee = Math.ceil(km - 1) * 5000;
            return Math.min(fee, 25000);
        }

        // Applied promo state
        let appliedPromo = null;

        // Apply promo code
        window.applyPromoCode = async function () {
            const code = document.getElementById('promoCodeInput').value.trim().toUpperCase();
            const msgEl = document.getElementById('promoMsg');
            if (!code) { msgEl.style.color='#ef4444'; msgEl.textContent='Vui lòng nhập mã khuyến mãi.'; return; }

            msgEl.style.color='#888'; msgEl.textContent='Đang kiểm tra...';
            try {
                const snap = await get(ref(db, 'promotions'));
                let found = null;
                if (snap.exists()) snap.forEach(c => { const v=c.val(); if(v.code===code) found={id:c.key,...v}; });

                function fmtDate(ts) {
                    return new Date(ts).toLocaleDateString('vi-VN', { day:'2-digit', month:'2-digit', year:'numeric' });
                }
                function setErr(msg) {
                    msgEl.style.color = '#ef4444';
                    msgEl.innerHTML = msg;
                    appliedPromo = null;
                    refreshDiscountUI();
                }

                if (!found) { setErr(`❌ Mã <strong>${code}</strong> không tồn tại. Vui lòng kiểm tra lại chính tả.`); return; }
                if (!found.isActive) { setErr(`🚫 Mã <strong>${found.code}</strong> đã bị vô hiệu hóa và không thể sử dụng.`); return; }
                const now = Date.now();
                if (found.startDate > now) {
                    setErr(`⏳ Mã <strong>${found.code}</strong> chưa đến ngày áp dụng. Mã có hiệu lực từ <strong>${fmtDate(found.startDate)}</strong>.`); return;
                }
                if (found.endDate < now) {
                    setErr(`⌛ Mã <strong>${found.code}</strong> đã hết hạn vào <strong>${fmtDate(found.endDate)}</strong>.`); return;
                }
                if (found.usageLimit > 0 && (found.usageCount||0) >= found.usageLimit) {
                    setErr(`🔒 Mã <strong>${found.code}</strong> đã đạt giới hạn ${found.usageLimit} lượt sử dụng.`); return;
                }

                // Kiểm tra điều kiện giờ áp dụng
                if (found.timeStart && found.timeEnd) {
                    const nowD = new Date();
                    const curH = String(nowD.getHours()).padStart(2,'0');
                    const curM = String(nowD.getMinutes()).padStart(2,'0');
                    const curMin = nowD.getHours() * 60 + nowD.getMinutes();
                    const [sh, sm] = found.timeStart.split(':').map(Number);
                    const [eh, em] = found.timeEnd.split(':').map(Number);
                    if (curMin < sh * 60 + sm || curMin > eh * 60 + em) {
                        setErr(`🕐 Mã <strong>${found.code}</strong> chỉ áp dụng trong khung giờ <strong>${found.timeStart} – ${found.timeEnd}</strong>. Hiện tại là <strong>${curH}:${curM}</strong>, ngoài khung giờ ưu đãi.`);
                        return;
                    }
                }

                const cart = getCart();
                const subtotal = cart.reduce((sum, i) => sum + i.price * i.quantity, 0);
                if (found.minOrder > 0 && subtotal < found.minOrder) {
                    const missing = formatPrice(found.minOrder - subtotal);
                    msgEl.style.color = '#ef4444';
                    msgEl.innerHTML = `🛒 Đơn hàng chưa đủ điều kiện. Mã <strong>${found.code}</strong> yêu cầu tối thiểu <strong>${formatPrice(found.minOrder)}</strong> — cần thêm <strong>${missing}</strong> nữa.`;
                    appliedPromo = null; refreshDiscountUI(); return;
                }

                appliedPromo = found;
                const discount = calcDiscount(found, subtotal);
                msgEl.style.color = '#10b981';
                const discTxt = found.discountType === 'percent'
                    ? `${found.discountValue}%${found.maxDiscount > 0 ? ' (tối đa ' + formatPrice(found.maxDiscount) + ')' : ''}`
                    : formatPrice(found.discountValue);
                msgEl.innerHTML = `✅ Áp dụng thành công! Mã <strong>${found.code}</strong> giảm ${discTxt} — bạn tiết kiệm <strong>${formatPrice(discount)}</strong>.`;
                refreshDiscountUI();
            } catch(e) { msgEl.style.color='#ef4444'; msgEl.textContent='Lỗi: '+e.message; }
        };

        function calcDiscount(promo, subtotal) {
            if (!promo) return 0;
            let discount = promo.discountType === 'percent'
                ? subtotal * promo.discountValue / 100
                : promo.discountValue;
            if (promo.discountType === 'percent' && promo.maxDiscount > 0)
                discount = Math.min(discount, promo.maxDiscount);
            return Math.min(discount, subtotal);
        }

        function refreshDiscountUI() {
            const cart = getCart();
            const subtotal = cart.reduce((sum, i) => sum + i.price * i.quantity, 0);
            const discount = calcDiscount(appliedPromo, subtotal);
            const discountRow = document.getElementById('discountRow');
            if (appliedPromo && discount > 0) {
                discountRow.style.display = '';
                document.getElementById('appliedPromoCode').textContent = appliedPromo.code;
                document.getElementById('discountAmt').textContent = '-' + formatPrice(discount);
            } else {
                discountRow.style.display = 'none';
            }
            // Dùng phí ship theo phường hiện tại
            const wardSelect = document.getElementById('ward');
            const wardName = wardSelect.options[wardSelect.selectedIndex]?.value || '';
            updateTotals(getShippingFee(wardName, subtotal));
        }

        // Cập nhật tổng tiền trong order summary
        function updateTotals(shippingFee) {
            const cart = getCart();
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discount = calcDiscount(appliedPromo, subtotal);
            const total = subtotal + shippingFee - discount;
            document.getElementById('subtotal').textContent = formatPrice(subtotal);
            document.getElementById('shipping').textContent =
                shippingFee === 0 ? 'Miễn phí 🎉' : formatPrice(shippingFee);
            document.getElementById('total').textContent = formatPrice(Math.max(0, total));
        }

        // Payment method selection
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', () => {
                document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                method.classList.add('selected');
                method.querySelector('input').checked = true;

                // Show/hide payment details
                const paymentValue = method.querySelector('input').value;
                document.getElementById('bankingDetails').style.display = paymentValue === 'banking' ? 'block' : 'none';
                document.getElementById('momoDetails').style.display = paymentValue === 'momo' ? 'block' : 'none';
            });
        });

        // Place order
        document.getElementById('placeOrderBtn').addEventListener('click', async () => {
            const fullName = document.getElementById('fullName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const address = document.getElementById('address').value.trim();
            const district = document.getElementById('district');
            const ward = document.getElementById('ward');
            const districtText = district.options[district.selectedIndex]?.text || '';
            const wardVal    = ward.options[ward.selectedIndex]?.value || '';
            const wardText   = ward.options[ward.selectedIndex]?.text  || '';
            const note = document.getElementById('note').value.trim();
            const payment = document.querySelector('input[name="payment"]:checked').value;

            // Validation
            if (!fullName || !phone || !email || !address) {
                Swal.fire({ icon: 'warning', title: 'Thiếu thông tin!', text: 'Vui lòng điền đầy đủ thông tin bắt buộc (họ tên, điện thoại, email, địa chỉ).' });
                return;
            }
            if (!district.value) {
                Swal.fire({ icon: 'warning', title: 'Thiếu thông tin!', text: 'Vui lòng chọn Quận/Huyện.' });
                return;
            }
            if (!wardVal) {
                Swal.fire({ icon: 'warning', title: 'Thiếu thông tin!', text: 'Vui lòng chọn Phường/Xã.' });
                return;
            }

            const cart = getCart();
            if (!cart.length) { window.location.href = 'cart.html'; return; }
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = getShippingFee(wardVal, subtotal);
            const discount = calcDiscount(appliedPromo, subtotal);
            const total = Math.max(0, subtotal + shipping - discount);

            const orderData = {
                customer: {
                    fullName,
                    phone,
                    email,
                    address,
                    ward: wardText,
                    district: districtText,
                    city: 'Cần Thơ'
                },
                items: cart,
                subtotal,
                shipping,
                discount,
                promoCode: appliedPromo ? appliedPromo.code : null,
                total,
                payment,
                note,
                status: 'pending',
                createdAt: Date.now(),
                userId: currentUser ? currentUser.uid : null
            };

            try {
                Swal.fire({
                    title: 'Đang xử lý đơn hàng...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Save order to Firebase
                const ordersRef = ref(db, 'orders');
                const newOrderRef = push(ordersRef);
                await set(newOrderRef, orderData);

                // Increment promo usageCount
                if (appliedPromo) {
                    try {
                        const snap = await get(ref(db, `promotions/${appliedPromo.id}/usageCount`));
                        const current = snap.exists() ? (snap.val() || 0) : 0;
                        await set(ref(db, `promotions/${appliedPromo.id}/usageCount`), current + 1);
                    } catch(_) {}
                    appliedPromo = null;
                }

                // Save order to localStorage for order-success page
                const orderSummary = {
                    id: newOrderRef.key,
                    customer: orderData.customer,
                    items: orderData.items,
                    subtotal: orderData.subtotal,
                    shipping: orderData.shipping,
                    discount: orderData.discount,
                    promoCode: orderData.promoCode,
                    total: orderData.total,
                    payment: orderData.payment,
                    status: orderData.status,
                    createdAt: orderData.createdAt
                };

                // Lưu vào localStorage TRƯỚC KHI chuyển trang
                localStorage.setItem('moonlight_last_order', JSON.stringify(orderSummary));

                // Debug: Log để kiểm tra
                console.log('Order saved:', orderSummary);

                // Clear cart theo user
                const cartUser = auth.currentUser;
                if (cartUser) localStorage.removeItem(`moonlight_cart_${cartUser.uid}`);
                updateCartCount();

                // Show success
                Swal.fire({
                    icon: 'success',
                    title: 'Đặt hàng thành công!',
                    html: `
                        <p>Cảm ơn bạn đã đặt hàng tại Moonlight Cafe!</p>
                        <p>Mã đơn hàng: <strong>${newOrderRef.key.slice(-8).toUpperCase()}</strong></p>
                        <p>Chúng tôi sẽ liên hệ sớm nhất để xác nhận.</p>
                    `,
                    confirmButtonText: 'Xem chi tiết đơn hàng',
                    confirmButtonColor: '#d4a574'
                }).then(() => {
                    // Chuyển đến trang chi tiết đơn hàng
                    window.location.href = 'order-success.html';
                });

            } catch (error) {
                console.error('Order error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Đặt hàng thất bại!',
                    text: 'Vui lòng thử lại sau'
                });
            }
        });

        // Initialize — cart/items được render trong onAuthStateChanged khi user sẵn sàng
        // (không gọi ở đây vì auth.currentUser chưa sẵn sàng ngay lập tức)

        // Danh sách phường/xã theo quận/huyện Cần Thơ
        const wardsData = {
            ninhKieu: [
                'Phường An Bình', 'Phường An Cư', 'Phường An Hòa', 'Phường An Khánh',
                'Phường An Lạc', 'Phường An Nghiệp', 'Phường An Phú', 'Phường Cái Khế',
                'Phường Hưng Lợi', 'Phường Tân An', 'Phường Xuân Khánh',
                'Phường Thới Bình', 'Phường Trà An', 'Phường Trà Nóc'
            ],
            binhThuy: [
                'Phường An Thới', 'Phường Bình Thủy', 'Phường Bùi Hữu Nghĩa',
                'Phường Long Hòa', 'Phường Long Tuyền', 'Phường Thới An Đông',
                'Phường Trà An', 'Phường Trà Nóc'
            ],
            caiRang: [
                'Phường Lê Bình', 'Phường Hưng Phú',
                'Phường Ba Láng', 'Phường Phú Thứ', 'Phường Tân Phú'
            ]
        };

        // Cập nhật dropdown phường khi chọn quận
        document.getElementById('district').addEventListener('change', function () {
            const wardSelect = document.getElementById('ward');
            const selectedDistrict = this.value;
            const wards = wardsData[selectedDistrict] || [];

            if (!selectedDistrict || wards.length === 0) {
                wardSelect.innerHTML = '<option value="">Chọn quận/huyện trước</option>';
                updateTotals(25000);
                return;
            }

            wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>' +
                wards.map(w => `<option value="${w}">${w}</option>`).join('');

            // Tự chọn phường đầu tiên để hiển thị phí ship ngay lập tức
            wardSelect.selectedIndex = 1;
            const firstWard = wards[0];
            const sub = getCart().reduce((s, i) => s + i.price * i.quantity, 0);
            updateTotals(getShippingFee(firstWard, sub));
        });

        // Cập nhật phí ship realtime khi chọn phường/xã
        document.getElementById('ward').addEventListener('change', function () {
            const wardName = this.value;
            const sub = getCart().reduce((s, i) => s + i.price * i.quantity, 0);
            updateTotals(getShippingFee(wardName, sub));
        });

        // Load gợi ý mã khuyến mãi — xếp hạng theo mức giảm thực tế
        async function loadPromoSuggestions() {
            const el = document.getElementById('promoSuggestions');
            if (!el) return;
            try {
                const snap = await get(ref(db, 'promotions'));
                const now  = Date.now();
                const nowD = new Date();
                const curMin = nowD.getHours() * 60 + nowD.getMinutes();
                const subtotal = getCart().reduce((s, i) => s + i.price * i.quantity, 0);

                const applicable = [];   // mã đủ điều kiện ngay bây giờ
                const needMore   = [];   // mã cần thêm tiền

                if (snap.exists()) {
                    snap.forEach(c => {
                        const p = c.val();
                        if (!p.isActive || p.startDate > now || p.endDate < now) return;
                        if (p.usageLimit > 0 && (p.usageCount || 0) >= p.usageLimit) return;
                        if (p.timeStart && p.timeEnd) {
                            const [sh, sm] = p.timeStart.split(':').map(Number);
                            const [eh, em] = p.timeEnd.split(':').map(Number);
                            if (curMin < sh * 60 + sm || curMin > eh * 60 + em) return;
                        }
                        const promo = { id: c.key, ...p };
                        // Tính mức giảm thực tế
                        let discAmt = 0;
                        if (subtotal >= (promo.minOrder || 0)) {
                            discAmt = promo.discountType === 'percent'
                                ? subtotal * promo.discountValue / 100
                                : promo.discountValue;
                            if (promo.discountType === 'percent' && promo.maxDiscount > 0)
                                discAmt = Math.min(discAmt, promo.maxDiscount);
                            discAmt = Math.min(discAmt, subtotal);
                            applicable.push({ ...promo, discAmt });
                        } else {
                            needMore.push({ ...promo, discAmt: 0, missing: promo.minOrder - subtotal });
                        }
                    });
                }

                if (!applicable.length && !needMore.length) { el.style.display = 'none'; return; }

                // Xếp theo mức giảm giảm dần
                applicable.sort((a, b) => b.discAmt - a.discAmt);
                needMore.sort((a, b) => a.missing - b.missing);

                const best = applicable[0];

                let html = '';

                // Banner mã lợi nhất
                if (best) {
                    html += `
                    <div style="background:linear-gradient(135deg,rgba(212,165,116,.18),rgba(212,165,116,.06));border:1.5px solid var(--accent,#d4a574);border-radius:10px;padding:10px 13px;margin-bottom:8px">
                        <div style="font-size:.73rem;color:var(--accent);font-weight:700;margin-bottom:4px;letter-spacing:.03em">
                            <i class="fas fa-crown"></i> GỢI Ý TỐT NHẤT CHO BẠN
                        </div>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
                            <div>
                                <span style="font-weight:800;font-size:.95rem;color:var(--accent)">${best.code}</span>
                                ${best.title ? `<span style="font-size:.78rem;color:var(--text-muted);margin-left:6px">${best.title}</span>` : ''}
                                <div style="font-size:.78rem;color:var(--text-secondary);margin-top:2px">
                                    Giảm ngay <strong style="color:#10b981">${formatPrice(best.discAmt)}</strong>
                                    ${best.discountType==='percent' ? `(${best.discountValue}%${best.maxDiscount>0?' · tối đa '+formatPrice(best.maxDiscount):''})` : ''}
                                </div>
                            </div>
                            <button type="button"
                                onclick="document.getElementById('promoCodeInput').value='${best.code}';applyPromoCode();"
                                style="flex-shrink:0;padding:7px 14px;background:var(--accent,#d4a574);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:.82rem;font-weight:700;white-space:nowrap">
                                <i class="fas fa-bolt"></i> Dùng ngay
                            </button>
                        </div>
                    </div>`;
                }

                // Các mã khác dưới dạng chip
                const others = applicable.slice(1);
                if (others.length > 0) {
                    html += `<div style="font-size:.72rem;color:var(--text-muted);margin-bottom:4px">Mã khác đang hoạt động:</div>`;
                    html += `<div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:6px">`;
                    others.forEach(p => {
                        const discTxt = p.discountType === 'percent' ? `Giảm ${p.discountValue}%` : `Giảm ${formatPrice(p.discountValue)}`;
                        html += `<button type="button"
                            onclick="document.getElementById('promoCodeInput').value='${p.code}';applyPromoCode();"
                            title="${p.title||p.code} — ${discTxt} · Tiết kiệm ${formatPrice(p.discAmt)}"
                            style="padding:3px 10px;border:1.5px dashed var(--accent,#d4a574);background:transparent;color:var(--accent,#d4a574);border-radius:20px;cursor:pointer;font-size:.74rem;font-weight:700"
                            onmouseover="this.style.background='rgba(212,165,116,.13)'" onmouseout="this.style.background='transparent'">
                            ${p.code} <span style="font-weight:400;font-size:.68rem">— ${formatPrice(p.discAmt)}</span>
                        </button>`;
                    });
                    html += `</div>`;
                }

                // Mã cần thêm tiền
                if (needMore.length > 0) {
                    html += `<div style="font-size:.72rem;color:var(--text-muted);margin-bottom:4px">Mua thêm để dùng mã:</div>`;
                    html += `<div style="display:flex;flex-wrap:wrap;gap:5px">`;
                    needMore.slice(0, 3).forEach(p => {
                        const discTxt = p.discountType === 'percent' ? `${p.discountValue}%` : formatPrice(p.discountValue);
                        html += `<span title="Cần thêm ${formatPrice(p.missing)} để dùng mã này"
                            style="padding:3px 10px;border:1.5px dashed #9ca3af;color:#9ca3af;border-radius:20px;font-size:.72rem;font-weight:600;cursor:default">
                            ${p.code} · còn thiếu ${formatPrice(p.missing)}
                        </span>`;
                    });
                    html += `</div>`;
                }

                el.style.display = '';
                el.innerHTML = html;
            } catch (_) { el.style.display = 'none'; }
        }
    </script>


    <!-- TuDongChat AI Chatbot -->
    <script src="https://app.tudongchat.com/js/chatbox.js"></script>
    <script>
        try {
            const tudong_chatbox = new TuDongChat('XUitpr3VDU2e5vJgSRYO9');
            tudong_chatbox.initial();
        } catch(e) {}
    </script>
    <script type="module">
        import { updateMsgBadge } from './js/nav-helper.js';
        import { auth, onAuthStateChanged } from './js/firebase-config.js';
        onAuthStateChanged(auth, user => updateMsgBadge(user ? user.uid : null));
    </script>
</body>

</html>